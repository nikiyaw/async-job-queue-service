<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asynchronous Job Queue Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        /* Minor style adjustments for badges */
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="text-center py-6 border-b border-gray-200 mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900">Worker Job Dashboard</h1>
            <p class="text-gray-500 mt-2">Manage and monitor asynchronous job processing status.</p>
        </header>

        <!-- Job Submission Card -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Submit New Job</h2>
            <div class="space-y-4">
                <div>
                    <label for="jobType" class="block text-sm font-medium text-gray-700 mb-1">Job Type</label>
                    <select id="jobType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="Send Email">Send Email (Quick)</option>
                        <option value="Long Computation">Long Computation (10s)</option>
                        <option value="Data Analysis">Data Analysis (Retry Example)</option>
                    </select>
                </div>
                <div>
                    <label for="payload" class="block text-sm font-medium text-gray-700 mb-1">Payload (MUST be valid JSON, e.g., {"user_id": 1})</label>
                    <input type="text" id="payload" value="{}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Enter optional JSON payload or text">
                </div>
                <button onclick="submitJob()" class="w-full px-4 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md">
                    Queue Job
                </button>
            </div>
            <div id="statusMessage" class="mt-4 text-center font-medium"></div>
        </div>

        <!-- Job List Card -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Queued and Completed Jobs</h2>
            <div id="jobList" class="space-y-4">
                <!-- Jobs will be rendered here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Mapping status to Tailwind classes for visual clarity
        const statusColors = {
            'queued': 'bg-gray-100 text-gray-800',
            'retrying': 'bg-orange-100 text-orange-800',
            'processing': 'bg-blue-100 text-blue-800',
            'completed': 'bg-green-100 text-green-800',
            'failed': 'bg-red-100 text-red-800',
        };

        async function submitJob() {
            const jobType = document.getElementById('jobType').value;
            const payloadRaw = document.getElementById('payload').value;
            const statusMessage = document.getElementById('statusMessage');

            let payloadObject;

            // CRITICAL FIX: Attempt to parse the payload string into a JSON object
            try {
                payloadObject = JSON.parse(payloadRaw);
            } catch (e) {
                statusMessage.className = 'mt-4 text-center font-medium text-red-600';
                statusMessage.textContent = `Error: Invalid JSON in Payload field. Please ensure it is a valid object (e.g., {"key": "value"}).`;
                return; // Stop submission
            }
            
            try {
                // Now submit the job with the correctly parsed payload object
                const response = await fetch('/jobs/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_type: jobType,
                        payload: payloadObject // This is now a JSON object, satisfying Pydantic
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    statusMessage.className = 'mt-4 text-center font-medium text-green-600';
                    statusMessage.textContent = `Job queued successfully! ID: ${data.job_id} - Status: ${data.status}`;
                } else {
                    // Improved error handling to show server-side error details
                    statusMessage.className = 'mt-4 text-center font-medium text-red-600';
                    
                    let errorMessage = 'Submission failed.';
                    if (data.detail && Array.isArray(data.detail)) {
                        // FastAPI 422 errors structure details as an array of objects
                        errorMessage = `Submission failed: ${data.detail[0].msg} at ${data.detail[0].loc.join('.')}`;
                    } else if (data.detail) {
                        errorMessage = `Submission failed: ${data.detail}`;
                    } else if (data.error) {
                        errorMessage = `Submission failed: ${data.error}`;
                    }
                    statusMessage.textContent = errorMessage;
                }
            } catch (error) {
                statusMessage.className = 'mt-4 text-center font-medium text-red-600';
                statusMessage.textContent = `Network error: ${error.message}`;
            }
            fetchJobs(); // Refresh job list after submission
        }

        function renderJobs(jobs) {
            const jobList = document.getElementById('jobList');
            jobList.innerHTML = ''; // Clear existing list

            // Sort by ID descending (most recent first)
            jobs.sort((a, b) => b.id - a.id);

            jobs.forEach(job => {
                // Handle status mapping slightly differently from SQL model's 'queued'
                const statusKey = job.status === 'queued' ? 'queued' : job.status;
                const statusClass = statusColors[statusKey] || 'bg-gray-100 text-gray-800';
                
                let resultDisplay = job.result ? JSON.stringify(job.result, null, 2) : 'N/A';
                if (job.status === 'failed' && job.error_message) {
                    // If failed, show the error message. Use job.error_message directly.
                    try {
                         // Attempt to pretty print if error_message is JSON, otherwise just use the string
                        resultDisplay = JSON.stringify(job.error_message, null, 2); 
                    } catch (e) {
                         resultDisplay = String(job.error_message);
                    }
                }

                const jobElement = document.createElement('div');
                jobElement.className = 'p-4 border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition duration-150';
                jobElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-bold text-gray-900">Job ID: ${job.id}</span>
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusClass} uppercase tracking-wider">
                            ${job.status}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-1">Type: <span class="font-medium text-gray-700">${job.job_type}</span></p>
                    <p class="text-sm text-gray-600 mb-1">Retries: <span class="font-medium text-gray-700">${job.retries || 0}</span></p>
                    <div class="mt-2">
                        <p class="text-sm font-medium text-gray-700 mb-1">Result / Error:</p>
                        <pre class="bg-gray-50 p-2 rounded-md text-xs overflow-x-auto text-gray-700">${resultDisplay}</pre>
                    </div>
                `;
                jobList.appendChild(jobElement);
            });
        }

        async function fetchJobs() {
            try {
                // FIX: Change to '/jobs/' to prevent the 307 Temporary Redirect loop
                const response = await fetch('/jobs/');
                if (response.ok) {
                    const jobs = await response.json();
                    renderJobs(jobs);
                } else {
                    console.error("Failed to fetch jobs:", response.status);
                }
            } catch (error) {
                console.error("Network error while fetching jobs:", error);
            }
        }

        // Fetch jobs immediately and then poll every 5 seconds for real-time updates
        fetchJobs();
        setInterval(fetchJobs, 5000); 
    </script>
</body>
</html>
